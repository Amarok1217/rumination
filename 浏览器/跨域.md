### 跨域

首先最基础的，为什么需要跨域？

**限制跨域（同源策略）是指限制两个网站相互读写对方的数据，合理性显而易见。**

**而你会有此疑问（为什么需要同源？我想直接调一下自己另一个服务器的接口都不行？）--是因为其中有几个网站（服务器/源）是你自己的，而你没有办法告诉浏览器它们是一伙的。**

#### 同源

1995 年，同源政策由 Netscape 公司引入浏览器。目前，所有浏览器都实行这个政策。

最初，它的含义是指，A 网页设置的 Cookie，B 网页不能打开，除非这两个网页"同源"。所谓"同源"指的是"三个相同"。

- 协议相同
- 域名相同
- 端口相同

举例来说，http://www.example.com/dir/page.html 这个网址，协议是 http://，域名是 www.example.com，端口是80（默认端口可以省略）。它的同源情况如下。

- http://www.example.com/dir2/other.html ：同源
- http://example.com/dir/other.html ：不同源（域名不同）
- http://v2.www.example.com/dir/other.html ：不同源（域名不同）
- http://www.example.com:81/dir/other.html ：不同源（端口不同）

为什么会有同源策略呢？同源策略的目的是什么呢？

**为了安全。为了保护网站的资源。**

比如我要做一个搜索网站。如果浏览器不限制跨域访问的话，那么我可以在网页里写 js 代码，直接访问百度的后台（调用百度的接口），获取搜索结果。那你看，写一个搜索网站就会变得非常轻松。但是百度不干呀。平白提供服务，但是连名字都没留下。

另一方面，如果不限制跨域访问，你先登录支付宝，浏览器就会保留你的登录状态，避免你每次访问支付宝的页面都去输入用户名和密码。然后你又去访问另一个网站。如果这个网站有恶意代码的话，就会利用浏览器里保留的支付宝的登录状态，去访问支付宝的网站，这时支付宝的后台会认为是你的操作。

同源策略限制了哪些行为呢？

- Cookie、LocalStorage 和 IndexDB 无法读取。

- DOM 无法获得。

- AJAX 请求不能发送。

前两项在如今 SPA 的潮流下，基本很少遇到了。而对我们日常开发而言，影响最大的还是 AJAX 请求。通常我们的前端代码不会和后端的服务部署在一起，那我们正常调用接口就会受到同源策略的影响，无法请求成功。

哪有没有什么办法，能够在保证安全的同时，允许我们自己信任的网站做跨域请求呢？

#### CORS

如果我们的服务端和客户端约定好，允许哪些地址的页面请求、允许什么样条件的客户端请求，如果满足种种条件后服务端就给予返回，是不是就可以了？

这个就是 CORS 的基本思路

具体实现的方法是：发送 Ajax 请求时，浏览器发现该请求不符合同源策略，会给该请求加一个请求头：Origin。后台收到请求后，如果确定接受请求则在返回结果中加入一个响应头：Access-Control-Allow-Origin;浏览器判断该响应头中是否包含 当前 Origin 的值，如果有则浏览器会处理响应，我们就可以拿到响应数据，如果没有浏览器直接驳回。

因此，CORS 的配置大部分是在服务端，个人经历里 egg.js 装了一个配置插件就可以了。或者直接配置 nginx 也可以。

### 其它跨域解决方案

- JSONP（通过 script 标签，只支持 get 请求）
- nginx/node 做中间层

开发环境中，可以通过 http-proxy-middleware 来解决。下一次就来看看他的源码，看他是怎么做到解决跨域的。
